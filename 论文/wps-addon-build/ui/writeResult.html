<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>撰写结果工具</title>
    <style>
        * {
            font-weight: 900;
            transition: 300ms;
        }

        *:disabled {
            opacity: 0.5;
        }

        body {
            margin: 20px;
            background-color: #fff;
        }

        input {
            margin: 6px 0px 0px 10px;
            width: calc(100% - 10px);
            max-width: 100px;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #000;
            background-color: #fff;
            font-size: medium;
            outline: none;
        }

        input[type='button'] {
            cursor: pointer;
        }

        input[type='button']:hover {
            background-color: #ccc;
        }

        input:disabled:hover {
            background-color: #fff;
            cursor: default;
        }

        input::placeholder {
            color: #0008;
        }

        label {
            display: inline-block;
            min-width: fit-content;
            /* width: 100px; */
            text-align: center;
            font-size: large;
        }

        /* 容器样式 */
        .box {
            display: flex;
            width: fit-content;
            margin-bottom: 20px;
            padding: 10px;
            border: 2px solid #000;
            border-radius: 15px;
        }

        /* base样式 */
        #base {
            flex-wrap: wrap;
        }

        #base>div[id] {
            display: flex;
            flex-direction: column;
            margin: 5px;
        }

        #dep label,
        #indep label {
            margin-right: 10px;
        }

        #dep>input,
        #base>div[id]>div[id] {
            display: flex;
            flex-wrap: wrap;
            margin-left: 20px;
        }

        /* tools样式 */
        .tools {
            display: flex;
            align-items: center;
        }

        .add,
        .dec,
        .del,
        .info {
            margin-left: 5px;
            width: 25px !important;
            height: 25px;
            color: #000;
            font-size: large;
            line-height: 10px;
        }


        /* MSDtable样式 */
        #MSDtable {
            margin-bottom: 20px;
        }

        #MSDtable table {
            border-collapse: collapse;
            width: 100%;
        }

        #MSDtable th,
        #MSDtable td {
            /* border: 1px solid #000; */
            padding: 5px;
            text-align: center;
        }

        #MSDtable th:first-child,
        #MSDtable td:first-child {
            background-color: #eee;
        }

        #MSDtable .MSD input {
            margin: 0 3px;
        }

        /* 编辑按钮样式 */
        .editor {
            display: flex;
            align-items: center;
            flex-direction: column-reverse;
            justify-content: space-between;
            margin-left: 10px;
        }

        .editor input {
            width: 80px;
            border-radius: 15px;
        }

        .editor textarea {
            width: 80px;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid black;
            outline: none;
            transition: none;
        }

        /* 输出 */
        #output {
            max-width: 800px;
            /* float: right; */
        }

        #output_content {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #000;
            outline: none;
            background-color: #fff;
        }

        #output_content[contentEditable=false] {
            background-color: #eee;
        }

        /* 网页工具 */
        #plus-tools {
            /* width: calc(100% - 20px); */
            display: flex;
            align-items: flex-start;
            flex-wrap: wrap;
        }

        #plus-tools * {
            display: inline-block;
            margin: 0 5px;
            border-radius: 5px;
            padding: 5px;
        }

        #plus-tools input {
            text-align: center;
            width: 80px;
            border-radius: 15px;
        }

        #debugInfo {
            color: red;
            font-size: small;
            list-style-type: none;
            background-color: #fff;
            flex: 1;
        }

        #debugInfo li {
            display: block;
            border-bottom: 1px solid #000;
            margin: 0;
            padding: 5px 0 0;
        }
    </style>
</head>

<body>
    <div id="plus-tools">
        <input type="button" value="夜间模式">
        <select id="mode" autofocus>
            <option>差异检验</option>
            <option>线性回归</option>
            <option>中介模型</option>
        </select>
        <ul id="debugInfo" ondblclick="this.innerHTML=''"></ul>
    </div>
    <ul id="datalists"></ul>
    <script desc="functions">
        function addElm(tag, ...config) { return Object.assign(document.createElement(tag), ...config); }
        function datalist(id, arr, func = e => e) {
            return `<datalist id="${id}">${arr.map((e, i) => `<option value="${func(e)}" index="${i}"></option>`).join('')}</datalist>`;
        }
        function Mode(...funcs) { return funcs[$('#mode').selectedIndex]($('#mode').value); }
        function addBox(key, id) {
            const op = {
                MSD(...level) {
                    let data = $('#MSDtable').MSDdata;
                    if (!data) throw '请先填写MSDtable';
                    let In = e => e != -1 ? true : false;
                    let w = data.rows.indexOf(level[0]),
                        h = data.columns.indexOf(level[0]);
                    if (In(w) == In(h)) {
                        throw In(w) ? '水平重复' : `水平缺失:${level[0]}`;
                    } else if (In(w)) {
                        h = data.columns.indexOf(level[1] || 'mean');
                        if (!In(h)) throw `水平缺失:${level[1]}`;
                    } else {
                        w = data.rows.indexOf(level[1] || 'mean');
                        if (!In(w)) throw `水平缺失:${level[1]}`;
                    }
                    let { M, SD } = data.data[w][h];
                    return {
                        M: M, SD: SD,
                        text: `(M = ${M.toFixed(2)}, SD = ${SD.toFixed(2)})`
                    }
                },
                ifRes(type, arg1, arg2) {
                    switch (type) {
                        case 'p**': return arg1 == 0 ? 'p < 0.001' : 'p = ' + arg1.toFixed(3);
                        case 'p*': return arg1 < 0.05 ? '显著' : '不显著';
                        case 'M': return arg1.M > arg2.M ? '大于' : '小于';
                        case 'ia': {
                            let names = arg1.split('×');
                            return names[1] ? `${arg1}交互作用` : arg1 + '主效应';
                        }
                        case 'orient': return arg1 > 0 ? '正向' : '反向';
                        default: break;
                    }
                },
                sign(p, l1, l2, msd1, msd2) {
                    return p < 0.05 ?
                        `${l1}的$dep${msd1.text}显著${op.ifRes('M', msd1, msd2)}${l2}${msd2.text}` :
                        `${l1}的$dep${msd1.text}与${l2}${msd2.text}无显著差异`;
                }
            };
            let boxInfo = {
                base() {
                    return {
                        innerHTML: `<div id="dep"><input id="d1" type="text" placeholder="因变量"></div>
                            <div id="indep"><div id="i1">
                                <input class="name" type="text" placeholder="自变量">
                                <input class="level" type="text" placeholder="水平1">
                                <input class="level" type="text" placeholder="水平2">
                            </div></div>`,
                        datas() { return [...$('#indep').$('div', 1)] },
                        confirm() {
                            // 更新变量
                            window['vs'] = [];
                            (function (...vs) {
                                let e; vs.filter(v => v.elm).forEach(v => {
                                    window[`${v.type}s`] = [];
                                    for (let i = 1; i <= v.elm.childElementCount - 1; i++) {
                                        Object.assign(e = $(`#${v.type}${i}`), v.get(e));
                                        window[e.id] = e;
                                        if (!window['vs'].includes(window[e.id])) {
                                            window[`${v.type}s`].push(window[e.id]);
                                            window['vs'].push(window[e.id]);
                                        }
                                    }
                                });
                            })({
                                type: 'd', elm: $('#dep'), get({ value }) { return { name: value } },
                            }, {
                                type: 'i', elm: $('#indep'), get(e) {
                                    return {
                                        name: e.$('input.name').value,
                                        ls: [...e.$('input.level', 1)].map(e => e.value),
                                    }
                                },
                            }, {
                                type: 'm', elm: $('#mediate'), get(e) { return { name: e.$('input.name').value, } }
                            });
                            // 更新 datalist
                            $('#datalists').innerHTML = '';
                            is.forEach(e => $('#datalists').innerHTML += datalist(`${e.id}_ls`, e.ls));
                            // 更新dom
                            $('#base ~ div[id]', 1).forEach(e => { e.remove(); });
                            Mode(e => {
                                addBox('MSDtable');
                                if (is.length + i1.ls.length == 3) addBox('Ttest');
                                else addBox('Ftest');
                            }, e => {
                                addBox('LinearModel');
                                addBox('Linear');
                            }, e => {
                                addBox('Mediation');
                                addBox('Indirect');
                            });

                        },
                        output() {
                            return Mode(e => {
                                let method = '';
                                if (is.length == 1 && i1.ls.length == 2 && ds.length == 1) method = `t检验`;
                                else {
                                    method = `${'0单双'[is.length] || '多'}因素`;
                                    if (ds.length > 1) method += '多元';
                                    method += '方差分析';
                                }
                                let indepInfo = is.map(({ name, ls }) => `${ls.length}(${name}: ${ls.join(' / ')})`);
                                return `对${ds.map(e => e.name).join('、')}采用${is.length > 1 ? indepInfo.join('×') : ''}${method}`
                            }, e => {
                                return `以${ds[0].name}为因变量，${is.map(e => e.name).join('、')}为自变量，进行标准${is.length > 1 ? '多元' : ''}线性回归`
                            }, e => {
                                return `通过回归分析考察在${i1.name}对${d1.name}的影响中${ms.map(e => e.name).join('、')}的中介作用`;
                            });
                        },
                        initFunc() {
                            $('#dep').addTools(1);
                            Mode(e => {
                                $('#indep').addTools(2);
                                $('#i1').addTools(5, 3);
                                this.title = e;
                            }, e => {
                                $('#indep').addTools(9);
                                $('#i1').addTools(3, 1);
                                this.title = e;
                            }, e => {
                                $('#indep').addTools(1);
                                $('#i1').$('.level', 1).forEach(e => e.remove());
                                this.insertBefore(addElm('div', {
                                    id: 'mediate', innerHTML: '<div id="m1"><input class="name" type="text" placeholder="中介变量"><div>'
                                }), this.editor).addTools(3, 1);
                                this.title = e;
                            });
                        }
                    }
                },
                // 差异检验
                MSDtable() {
                    return {
                        innerHTML: `<table id="MSDtable_body" class="data"></table>`,
                        datas() { return [...this.$('.data').$('tbody').children] },
                        confirm() {
                            let dataArr = this.datas().map(e => {
                                let row = [...e.$('.MSD', 1)].map(ee => {
                                    return {
                                        M: parseFloat(ee.children[0].value),
                                        SD: parseFloat(ee.children[1].value)
                                    }
                                });
                                return [...row, { M: row.mean('M'), SD: row.mean('SD') }]
                            });
                            let i2 = window['i2'] || { ls: [] };
                            this.MSDdata = {
                                rows: [...i2.ls, 'mean'],
                                columns: [...i1.ls, 'mean'],
                                data: [...dataArr, dataArr[0].map((e, i) => {
                                    return {
                                        M: dataArr.map(ee => ee[i]).mean('M'),
                                        SD: dataArr.map(ee => ee[i]).mean('SD')
                                    }
                                })],
                            };
                        },
                        update() {
                            let head, body;
                            let i2 = window['i2'] || { name: '', ls: [''] };
                            head = `<tr>${[
                                `<th>${i2.name}\\${i1.name}</th>`,
                                ...i1.ls.map((e, i) => `<th id="i1l${i + 1}">${e}</th>`)
                            ].join('')}</tr>`;
                            body = i2.ls.map((e, i) => `<tr><th id="i2l${i + 1}">${e}</th>
                                    ${i1.ls.map((ee, j) => this.dataElm(`i2l${i + 1}&i1l${j + 1}_MSD`, 'M,SD', { tag: 'th', className: 'MSD' })).join('')}</tr>`).join('');
                            this.$('.data').innerHTML = `<thead>${head}</thead><tbody>${body}</tbody>`;
                        },
                    }
                },
                Ttest() {
                    return {
                        confirm() { this.writeData(this.$('#i1_Ttest_data')); },
                        update() {
                            $('#Ttest_body').innerHTML = this.dataElm('i1_Ttest', 't,df,p,CohenD|Cohen d,ciL|CI下限,ciU|CI上限',
                                { elms: [{ elm: `<label>${i1.name}</label>` }] });
                        },
                        output() {
                            return (function ({ ls, t, df, p, CohenD, ciL, ciU }) {
                                let [l1, l2] = ls;
                                let msd1 = op.MSD(l1), msd2 = op.MSD(l2);
                                return `${op.sign(p, l1, l2, msd1, msd2)}, t(${df}) = ${t.toFixed(2)}, ${op.ifRes('p**', p)}, Cohen d = ${CohenD.toFixed(2)}, 90%CI[${`${ciL.toFixed(2)}, ${ciU.toFixed(2)}`}]`
                            })(i1);
                        }
                    }
                },
                Ftest() {
                    return {
                        datas() { return [...$('#Ftest_body').children] },
                        confirm() {
                            $('.post,.simple', 1).forEach(e => e.remove());
                            this.is = [];
                            this.datas().map(e => {
                                let i = this.writeData(e);
                                this.is.push(i);
                                if (i.p < 0.05) {
                                    if (i.id.includes('×')) addBox('simple', i.id);
                                    else if (i.ls.length > 2) addBox('post', i.id);
                                }
                            });
                        },
                        update() {
                            let data = [];
                            is.forEach((e, i) => {
                                data.push(...is.choose(i + 1).map(es => {
                                    let id = es.map(e => e.id).join('×');
                                    if (i > 0) window[id] = { id: id, name: es.map(e => e.name).join('×'), is: es, };
                                    return this.dataElm(`${id}_Ftest`, 'F,df1,df2,p,eta2|η2,ciL|CI下限,ciU|CI上限', { elms: [{ elm: `<label>${window[id].name}</label>` }] });
                                }));
                            });
                            $('#Ftest_body').innerHTML = data.join('');
                        },
                        output() {
                            return this.is.map(function ({ name, F, df1, df2, p, eta2, ciL, ciU }) {
                                return `${op.ifRes('ia', name)}${op.ifRes('p*', p)}, F(${df1}, ${df2}) = ${F.toFixed(2)}, ${op.ifRes('p**', p)}, η2 = ${eta2.toFixed(2)}, 90%CI[${`${ciL.toFixed(2)}, ${ciU.toFixed(2)}`}]`
                            }).join('；');
                        },
                    }
                },
                post() {
                    return {
                        i: window[id],
                        id: `${id}_post`,
                        className: 'post box',
                        title: `${id} 事后检验`,
                        innerHTML: `<label for="${id}">${window[id].name}</label>
                            <div id="${id}_post_body"></div>`,
                        confirm() { this.writeData($(`#${id}_post_body`), 'post'); },
                        update() {
                            $(`#${id}_post_body`).innerHTML = this.i.ls.choose(2).map((e, i) =>
                                this.dataElm(`${id}_post${i}`, `l1|水平1|text|value="${e[0]}",l2|水平2|text|value="${e[1]}",p`,
                                    { elms: [{ elm: '<input class="del" type="button" value="×" onclick="this.del()" >', index: 2 }] })).join('')
                        },
                        output() {
                            return `对${this.i.name}进行事后检验发现，${this.i.post.map(function ({ l1, l2, p }) {
                                let msd1 = op.MSD(l1), msd2 = op.MSD(l2);
                                return `${op.sign(p, l1, l2, msd1, msd2)}, ${op.ifRes('p**', p)}`
                            }).join('；')}。`;
                        },
                        initFunc() { this.$('textarea').style.display = 'none'; },
                    }
                },
                simple() {
                    return {
                        i: window[id],
                        id: `${id}_simple`,
                        className: 'simple box',
                        title: `${id} 简单效应分析`,
                        innerHTML: `<label for="${id}">${window[id].name}</label>
                            <div id="${id}_simple_body"></div>`,
                        confirm() {
                            this.writeData($(`#${id}_simple_body`), 'simple');
                        },
                        update() {
                            let args = [];
                            window[id].is.forEach((e, i, arr) => {
                                arr[i].ls.forEach(l => {
                                    arr[+!i].ls.choose(2).forEach(ll => {
                                        args.push({ fi: e.name, fil: l, l1: ll[0], l2: ll[1] })
                                    });
                                });
                            });
                            $(`#${id}_simple_body`).innerHTML = args.map((e, i) =>
                                this.dataElm(`${id}_simple${i + 1}`,
                                    `fi|固定自变量|text|value="${e.fi}",fil|固定水平|text|value="${e.fil}",l1|水平1|text|value="${e.l1}",l2|水平2|text|value="${e.l2}",p`,
                                    { elms: [{ elm: '<input class="del" type="button" value="×" onclick="this.del()">', index: 4 }, { elm: ' :', index: 1 }] }
                                )).join('');
                        },
                        output() {
                            return `${this.i.name}的简单效应分析发现，${this.i.simple.map(function ({ l1, l2, p, fi, fil }) {
                                let msd1 = op.MSD(fil, l1), msd2 = op.MSD(fil, l2);
                                return `${fi}为${fil}时，${op.sign(p, l1, l2, msd1, msd2)}, ${op.ifRes('p**', p)}`
                            }).join('；')}。`
                        },
                        initFunc() { this.$('textarea').style.display = 'none'; },
                    }
                },
                // 线性回归
                LinearModel() {
                    return {
                        confirm() { this.writeData(this.$('#model_data')); },
                        output() {
                            return (function ({ R2, F, df1, df2, p }) {
                                return `整体模型调整后的解释方差为${(R2 * 1e2).toFixed(1)}%, F(${df1}, ${df2}) = ${F.toFixed(2)}, ${op.ifRes('p**', p)}`
                            })(window['model']);
                        },
                        update() {
                            $('#LinearModel_body').innerHTML =
                                this.dataElm('model', 'R2|调整后R方,F,df1,df2|||onchange="window.$(\'#i1_Linear_df\').value=this.value",p',
                                    { elms: [{ elm: `<label>回归模型</label>` }] });
                        },
                        initFunc() { this.$('textarea').style.display = 'none'; },
                    }
                },
                Linear() {
                    return {
                        datas() { return [...$('#Linear_body').children] },
                        confirm() { this.is = this.datas().map(this.writeData); },
                        update() {
                            $('#Linear_body').innerHTML = is.map(({ id }) => this.dataElm(`${id}_Linear`, 'beta|标准β,t,df,p',
                                { elms: [{ elm: `<label>${window[id].name}</label>` }] })).join('');
                        },
                        output() {
                            return this.is.map(({ name, beta, t, df, p, ls }) =>
                                `${name}的${op.ifRes('orient', beta)}预测作用${op.ifRes('p*', p)}, β = ${beta.toFixed(2)}, t(${df}) = ${t}, ${op.ifRes('p**', p)}`
                            ).join('；');
                        },
                    }
                },
                // 中介模型
                Mediation() {
                    return {
                        datas() { return [...this.$('.data>div[id]', 1)] },
                        confirm() { this.datas().forEach(e => this.writeData(e, 'args')); },
                        update() {
                            this.models = [];
                            [i1, ...ms, d1].choose(2).forEach(e => {
                                let model = this.models.find(t => t.y == e[1]);
                                model ? model.x.push(e[0]) : this.models.push({ y: e[1], x: [e[0]] });
                            });
                            this.$(`.data`).innerHTML = this.models.map(({ y, x }) =>
                                `<div id="${y.id}_model"><label>${y.name}</label>
                                    ${x.map(e => this.dataElm(e.id, `name|预测变量|text|value="${e.name}",beta|标准β,p`, {
                                    elms: [{ elm: '<input class="del" type="button" value="×" onclick="this.del()">', index: 2 }]
                                })).join('')}</div>`
                            ).join('<hr>');
                        },
                        output() {
                            return this.models.map(({ y }) =>
                                `以${y.name}为因变量，` + y.args.map(({ name, beta, p }) =>
                                    `${name}对${y.name}的${op.ifRes('orient', beta)}预测作用${op.ifRes('p*', p)}，β = ${beta.toFixed(2)}, ${op.ifRes('p**', p)}`
                                ).join('，')
                            ).join('；');
                        },
                    }
                },
                Indirect() {
                    return {
                        datas() { return [...this.$(`.data`).children] },
                        confirm() { this.paths = this.datas().map(this.writeData); },
                        update() {
                            this.$(`.data`).innerHTML = ms.map((e, i, arr) => arr.choose(i + 1).map(es => {
                                let path = [i1.name, ...es.map(e => e.name), d1.name].join('→');
                                return this.dataElm(`${path}`, 'effect|间接效应,ciL|CI下限,ciU|CI上限', {
                                    elms: [{ elm: `<label>${path}</label>` },
                                    { elm: '<input class="del" type="button" value="×" onclick="this.del()">', index: 3 }]
                                })
                            }).join('')).join('');
                        },
                        output() {
                            return `${this.paths.map(function ({ name, effect, ciL, ciU }) {
                                return `${name}：${effect.toFixed(2)}, 95%BootCI[${ciL.toFixed(2)}, ${ciU.toFixed(2)}]`
                            }).join('；')}。`;
                        },
                    }
                },
                // 调节模型
                Moderation() { },
                // 输出模块
                output() {
                    return {
                        innerHTML: `<div id="output_content" contenteditable></div>`,
                        confirm() { // 复制文本
                            $('#output_content').contentEditable = false;
                            let { innerText, innerHTML } = $('#output_content');
                            navigator.clipboard.write([
                                new ClipboardItem({
                                    'text/plain': new Blob([innerText], { type: 'text/plain' }),
                                    'text/html': new Blob([innerHTML], { type: 'text/html' }),
                                })
                            ]).then(e => alert('复制成功\n可以带格式粘贴'));
                        },
                        onEdit() {
                            $('#output_content').contentEditable = true;
                            $('#output_content').focus();
                        },
                        update() {
                            function txt(text, tag, style = "") {
                                if (tag == 'p') {
                                    style += `font-family: 'Times New Roman','宋体';
                                        font-size: 10.5pt;font-weight: normal;
                                        text-indent: 2em;margin: 0;line-height: 1.5;`;
                                    text = format(text);
                                }
                                return `<${tag} style="${style}">${text}</${tag}>`
                            }
                            function format(text) {
                                return text.replace(/[χη](2)/g, `η${txt('$1', 'sup')}`)
                                    .replace(/ (F|p|t|d|M|SD|r|N|n)/g, ` ${txt('$1', 'i')}`)
                                    .replace(/(CI)\[/g, `${txt('$1', 'i')}[`)
                                    .replace(/\((M) /g, `(${txt('$1', 'i')} `)
                                    .replace(/(t|F)检验/g, `${txt('$1', 'i')}检验`)
                                    .replace(/ -(\d)/g, ` —$1`)
                                    .replace(/\$dep/g, d1.name);
                            }
                            // 主要内容
                            $('#output_content').innerHTML = Mode(e => {
                                return txt(`${$('#base').output()}。结果发现，${($('#Ttest') || $('#Ftest')).output()}。`, 'p')
                                    + [...$('.post', 1)].map(e => txt(e.output(), 'p')).join('')
                                    + [...$('.simple', 1)].map(e => txt(e.output(), 'p')).join('');
                            }, e => {
                                return txt(`${$('#base').output()}，各变量的相关矩阵见表1。回归分析结果显示，${$('#LinearModel').output()}。`, 'p')
                                    + txt(`当其他自变量不变时，${$('#Linear').output()}。`, 'p');
                            }, e => {
                                return txt(`${$('#base').output()}，结果如图1所示。结果表明，${$('#Mediation').output()}。`, 'p')
                                    + txt(`间接效应：${$('#Indirect').output()}`, 'p');
                            });
                        },
                        initFunc() {
                            $('#output_content').focus();
                            this.$('textarea').style.display = 'none';
                            if ($('html').style.filter) $('#output_content').style.filter = 'invert(1)';
                        },
                    }
                }
            }
            let elm = $('body').appendChild(addElm('div', {
                id: key,
                className: 'box',
                innerHTML: `<div id="${key}_body" class="data"></div>`,
                onkeypress(e) {
                    switch (e.code) {
                        case 'Enter': this.$('.editor input[type=button]').click(); break;
                        default: break;
                    }
                }
            }, boxInfo[key]())).init();
            // 自动填充
            db.autofill && elm.$('input', 1).forEach(e => {
                e.value = e.value || (function () {
                    switch (e.type) {
                        case 'number': switch (e.placeholder) {
                            case 'p': return (Math.random() * 0.1).toFixed(3);
                            case 'df': return (Math.random() * 100).toFixed(0);
                            case 'df1': return (Math.random() * 100).toFixed(0);
                            case 'df2': return (Math.random() * 100).toFixed(0);
                            default: return (Math.random() * 5).toFixed(3);
                        }
                        case 'text': switch (e.placeholder) {
                            case '因变量': return 'Y';
                            case '自变量': return 'X';
                            case '中介变量': return 'M';
                            case '调节变量': return 'N';
                            case '水平1': return 'Lv1';
                            case '水平2': return 'Lv2';
                            default: return `${String.fromCharCode(...[0, 0].map(e => parseInt(Math.random() * (90 - 65 + 1) + 65, 10)))}`;
                        };
                        default: return e.type;
                    }
                })(e);
            });
            return elm;
        }
    </script>
    <script desc="init">
        const db = { autofill: 0, autoOutput: 1 };
        const _insertBefore = Node.prototype.insertBefore;
        const _appendChild = Node.prototype.appendChild;
        Object.assign(Storage.prototype, {
            setExpire(key, value, expire) {
                let obj = {
                    data: value,
                    time: Date.now(),
                    expire: expire
                };
                localStorage.setItem(key, JSON.stringify(obj));
            },
            getExpire(key) {
                let val = localStorage.getItem(key);
                if (!val) { return val; }
                val = JSON.parse(val);
                if (Date.now() - val.time > val.expire) {
                    localStorage.removeItem(key);
                    return null;
                }
                return val.data;
            },
        })
        Object.assign(Object.prototype, {
            or: function (key, a, b) { let logic = this[key] == a; this[key] = logic ? b : a; return logic },
            $: function (Selectors, isAll) {
                let _this = this == window ? document : this;
                return isAll ? _this.querySelectorAll(Selectors) : _this.querySelector(Selectors);
            },
        });
        Object.assign(Array.prototype, {
            mean: function (key) { let sum = 0; this.forEach(e => sum += e[key]); return sum / this.length },
            choose: function (size) {
                var allResult = [];
                (function (arr, size, result) {
                    var arrLen = arr.length;
                    if (size > arrLen) return;
                    if (size == arrLen) {
                        allResult.push([].concat(result, arr));
                    } else {
                        for (var i = 0; i < arrLen; i++) {
                            var newResult = [].concat(result);
                            newResult.push(arr[i]);
                            if (size == 1) {
                                allResult.push(newResult);
                            } else {
                                var newArr = [].concat(arr);
                                newArr.splice(0, i + 1);
                                arguments.callee(newArr, size - 1, newResult);
                            }
                        }
                    }
                })(this, size, []);
                return allResult;
            }
        });
        Object.assign(HTMLInputElement.prototype, {
            add: function (max = 4) {
                let tree = this.parentElement.parentElement;
                let source = tree.lastElementChild;
                if (tree.childElementCount < max) {
                    function selfAdd(attribute) {
                        if (attribute) {
                            let index = parseInt(attribute.slice(-1));
                            if (!isNaN(index)) return attribute.slice(0, -1) + (index + 1);
                        }
                        return ''
                    }
                    tree.appendChild(Object.assign(source.cloneNode(true), {
                        id: selfAdd(source.id),
                        placeholder: selfAdd(source.placeholder),
                        title: selfAdd(source.title),
                        value: selfAdd(source.value),
                    }));
                }
            },
            dec: function (min = 2) {
                let tree = this.parentElement.parentElement;
                if (tree.childElementCount == 3 && /^indep\d$/.test(tree.id)) tree.appendChild = e => e;
                if (tree.childElementCount > min) tree.lastElementChild.remove();
            },
            del: function () { this.parentElement.remove() },
            info: function () { },
        });
        Object.assign(HTMLDivElement.prototype, {
            init() {
                this.editor = this.addEditor(this.onCheck, this.onEdit);
                this.datas = this.datas || function () { return [this] };
                this.update && this.update();
                this.initFunc && this.initFunc();
                // label 对齐
                let list = [...this.$('label', 1)],
                    max = Math.max(...list.map(e => parseFloat(getComputedStyle(e).width)));
                list.forEach(e => e.style.width = max + 'px');
                return this;
            },
            dataElm(id, exp = 'name|placeholder|type|other,', config = {}) {
                let arr = exp.split(',').map(e => e.split('|'));
                let inputs = arr.map(e => `<input id="${id}_${e[0]}" type="${e[2] || 'number'}" placeholder="${e[1] || e[0]}" ${e[3] || ''}>`).join('\n');
                let dataElm = addElm(config.tag || 'div', { id: `${id}_data`, innerHTML: inputs, }, config);
                // 添加元素
                config.elms && config.elms.forEach(e => {
                    typeof e.index == 'number' ?
                        dataElm.children[e.index].outerHTML += e.elm :
                        dataElm.innerHTML = e.elm + dataElm.innerHTML;
                });
                return dataElm.outerHTML;
            },
            readTextareaData() {
                let textarea = this.editor.$('textarea');
                let text = textarea.value.replace(/ +/g, '').replace(/\n$/, ''),
                    arr = text.split('\n').map(e => e.split('\t'));
                textarea.value = '';
                if (arr[1]) {
                    let list = this.datas().map(e => e.$('input[placeholder]', 1));
                    arr.forEach((e, r) => {
                        e.forEach((ee, c) => { if (list[r] && list[r][c]) list[r][c].value = ee; });
                    });
                }
            },
            writeData(dataElm, prop) {
                let id = dataElm.id.split('_')[0];
                window[id] = window[id] || { name: id };
                let obj = window[id];
                function data(elm) { // 根据单个元素 返回数据对象
                    let obj = {};
                    elm.$('input[id]', 1).forEach(e => {
                        obj[e.id.match(/_([^_]+)$/)[1]] = e.type == 'number' ? +e.value : e.value;
                    });
                    return obj;
                }
                if (typeof prop == 'string') { // 多个元素 写入数组
                    !function selet(arr) {
                        let p = arr.shift();
                        if (arr[0]) { obj = obj[p] = {}; selet(arr); }
                        else { obj = obj[p] = []; }
                    }(prop.split('.'));
                    Object.assign(obj, [...dataElm.$('div[id]', 1)].map(data));
                } else { // 单个元素 写入对象
                    Object.assign(obj, data(dataElm));
                }
                return window[id];
            },
            onCheck() {
                this.readTextareaData();
                let errInput = [];
                let colors = function (isOK) {
                    isOK = isOK + 0;
                    if ($('html').style.filter) return ['#0ff7', '#f0f7'][isOK]; // dark 模式
                    else return ['#f005', '#0f05'][isOK];
                };
                [... this.$('input[placeholder]', 1)].forEach(e => {
                    e.style.backgroundColor = colors(e.pass = true);
                    if (['', NaN, undefined].includes(e.value)) errInput.push(e);
                });
                if (errInput[0]) errInput.forEach(e => e.style.backgroundColor = colors(e.pass = false));
                else this.confirm(), console.log(this.output());
            },
            onEdit() {
                [... this.$('input[placeholder]', 1)].forEach(e => {
                    e.style.backgroundColor = e.pass = '';
                });
            },
            output() { return this.id },
        });
        Object.assign(Node.prototype, {
            addTools: function (max, min) {
                return this.insertBefore(addElm('span', {
                    id: `${this.id}_tools`,
                    className: 'tools',
                    innerHTML: `<input class="add" type="button" value="+" onclick="this.add(${max + 1})">
                                <input class="dec" type="button" value="-" onclick="this.dec(${min + 1})">`,
                }), this.children[0]);
            },
            addEditor: function (func1 = () => { }, func2 = () => { }) {
                let _this = this;
                let elm = this.appendChild(addElm('span', {
                    id: `${this.id}_editor`,
                    className: 'editor',
                    innerHTML: `<input type="button" value="确认" onclick="this.handle()">
                               <!-- <input type="button" value="i" class="info" onclick="this.info()"> -->
                                <textarea cols="2" rows="1"></textarea>`,
                }));
                elm.$('input').handle = function () {
                    [..._this.$('input', true)].filter(e => e.id || e.className).forEach(e => e.disabled = !e.disabled);
                    elm.$('textarea').or('disabled', true, false);
                    elm.$('textarea').style.or('resize', '', 'none');
                    (this.or('value', '确认', '编辑')) ? func1.call(_this) : func2.call(_this);
                    // 显示/更新输出模块
                    if (db.autoOutput && [...$('.box', 1)].every(e =>
                        [...e.$('input[placeholder]', 1)].every(i => i.pass)))
                        $('#output') ? $('#output').update() : addBox('output');
                };
                return elm;
            },
            insertBefore: function (node, pos) {
                let o = node.id && $(`#${node.id}`);
                if (!o) return _insertBefore.call(this, node, pos);
                else console.log(`已存在`, o);
                return o;
            },
            appendChild: function (node) {
                let o = node.id && $(`#${node.id}`);
                if (!o) return _appendChild.call(this, node);
                else console.log(`已存在`, o);
                return o;
            },
        });
    </script>
    <script desc="main">
        window.onerror = function (...e) { $('#debugInfo').appendChild(addElm('li', { innerHTML: `${e[2]}&nbsp;&nbsp;&nbsp;${e[0]}` })); };
        $('input[value=夜间模式]').onclick = function () {
            $('html,#output_content', 1).forEach(e => e.style.or('filter', 'invert(1)', ''));
            localStorage.setExpire('wr_night', $('html').style.filter, 7 * 24 * 60 * 6e4);
        };
        $('#mode').onchange = function () {
            $('script ~ div[id]', 1).forEach(e => e.remove());
            addBox('base'); localStorage.setExpire('wr_method', this.selectedIndex, 7 * 24 * 60 * 6e4);
        };
        $('html').style.filter = localStorage.getExpire('wr_night') || '';
        $('#mode').selectedIndex = localStorage.getExpire('wr_method') || 0;
        $('#mode').onchange();
    </script>
</body>

</html>