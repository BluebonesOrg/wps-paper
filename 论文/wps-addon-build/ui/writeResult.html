<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>撰写结果工具</title>
    <style>
        * {
            font-weight: 900;
            transition: 300ms;
        }

        *:disabled {
            opacity: 0.5;
        }

        body {
            margin: 20px;
            background-color: #fff;
        }

        input {
            margin: 6px 0px 0px 10px;
            width: calc(100% - 10px);
            max-width: 100px;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid #000;
            background-color: #fff;
            font-size: medium;
            outline: none;
        }

        input[type='button'] {
            cursor: pointer;
        }

        input[type='button']:hover {
            background-color: #ccc;
        }

        input:disabled:hover {
            background-color: #fff;
            cursor: default;
        }

        input::placeholder {
            color: #0008;
        }

        label {
            display: inline-block;
            min-width: fit-content;
            width: 100px;
            text-align: center;
            font-size: large;
        }

        /* 容器样式 */
        .box {
            display: flex;
            width: fit-content;
            margin-bottom: 20px;
            padding: 10px;
            border: 2px solid #000;
            border-radius: 15px;
        }

        #MSDtable span textarea,
        #Ttest span textarea,
        #Ftest span textarea,
        #Linear span textarea {
            display: inline-block;
        }

        /* base样式 */
        #base {
            flex-wrap: wrap;
        }

        #dep,
        #indep {
            display: flex;
            flex-direction: column;
            margin: 5px;
        }

        #dep label,
        #indep label {
            margin-right: 10px;
        }

        #dep>input,
        #indep>div {
            display: flex;
            flex-wrap: wrap;
            margin-left: 20px;
        }

        /* tools样式 */
        .tools {
            display: flex;
            align-items: center;
        }

        .add,
        .dec,
        .del,
        .info {
            margin-left: 5px;
            width: 25px !important;
            height: 25px;
            color: #000;
            font-size: large;
            line-height: 10px;
        }


        /* MSDtable样式 */
        #MSDtable {
            margin-bottom: 20px;
        }

        #MSDtable table {
            border-collapse: collapse;
            width: 100%;
        }

        #MSDtable th,
        #MSDtable td {
            /* border: 1px solid #000; */
            padding: 5px;
            text-align: center;
        }

        #MSDtable th:first-child,
        #MSDtable td:first-child {
            background-color: #eee;
        }

        #MSDtable .MSD input {
            margin: 0 3px;
        }

        /* 编辑按钮样式 */
        .editor {
            display: flex;
            align-items: center;
            flex-direction: column-reverse;
            justify-content: space-between;
            margin-left: 10px;
        }

        .editor input {
            width: 80px;
            border-radius: 15px;
        }

        .editor textarea {
            width: 80px;
            padding: 5px;
            border-radius: 5px;
            border: 1px solid black;
            outline: none;
            transition: none;
        }

        /* 输出 */
        #output {
            max-width: 800px;
            /* float: right; */
        }

        #output_content {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #000;
            outline: none;
            background-color: #fff;
        }

        #output_content[contentEditable=false] {
            background-color: #eee;
        }

        /* 网页工具 */
        #plus-tools {
            /* width: calc(100% - 20px); */
            display: flex;
            align-items: flex-start;
            flex-wrap: wrap;
        }

        #plus-tools * {
            display: inline-block;
            margin: 0 5px;
            border-radius: 5px;
            padding: 5px;
        }

        #plus-tools input {
            text-align: center;
            width: 80px;
            border-radius: 15px;
        }

        #debugInfo {
            color: red;
            font-size: small;
            list-style-type: none;
            background-color: #fff;
            flex: 1;
        }

        #debugInfo li {
            display: block;
            border-bottom: 1px solid #000;
            margin: 0;
            padding: 5px 0 0;
        }
    </style>
</head>

<body>
    <div id="plus-tools">
        <input type="button" value="夜间模式"
            onclick="window.$('html,#output_content',1).forEach(e=>e.style.or('filter', 'invert(1)', ''));"></input>
        <input type="button" value="输出结果"
            onclick="let elm=window.$('#output');elm?elm.update():addBox('output');"></input>
        <select id="mode" autofocus
            onchange="window.$('script ~ div[id]', 1).forEach(e => e.remove()); addBox('base');">
            <option>差异检验</option>
            <option>线性回归</option>
            <option>中介模型</option>
        </select>
        <ul id="debugInfo" ondblclick="this.innerHTML=''"></ul>
    </div>
    <ul id="datalists"></ul>
    <script>
        const _insertBefore = Node.prototype.insertBefore;
        const _appendChild = Node.prototype.appendChild;
        Object.assign(Object.prototype, {
            or: function (key, a, b) { let logic = this[key] == a; this[key] = logic ? b : a; return logic },
            $: function (Selectors, isAll) {
                let _this = this == window ? document : this;
                return isAll ? _this.querySelectorAll(Selectors) : _this.querySelector(Selectors);
            },
        });
        Object.assign(Array.prototype, {
            mean: function (key) { let sum = 0; this.forEach(e => sum += e[key]); return sum / this.length },
            choose: function (size) {
                var allResult = [];
                (function (arr, size, result) {
                    var arrLen = arr.length;
                    if (size > arrLen) return;
                    if (size == arrLen) {
                        allResult.push([].concat(result, arr));
                    } else {
                        for (var i = 0; i < arrLen; i++) {
                            var newResult = [].concat(result);
                            newResult.push(arr[i]);
                            if (size == 1) {
                                allResult.push(newResult);
                            } else {
                                var newArr = [].concat(arr);
                                newArr.splice(0, i + 1);
                                arguments.callee(newArr, size - 1, newResult);
                            }
                        }
                    }
                })(this, size, []);
                return allResult;
            }
        });
        Object.assign(HTMLInputElement.prototype, {
            add: function (max = 4) {
                let tree = this.parentElement.parentElement;
                let source = tree.lastElementChild;
                if (tree.childElementCount < max) {
                    function selfAdd(attribute) {
                        if (attribute) {
                            let index = parseInt(attribute.slice(-1));
                            if (!isNaN(index)) return attribute.slice(0, -1) + (index + 1);
                        }
                        return ''
                    }
                    tree.appendChild(Object.assign(source.cloneNode(true), {
                        id: selfAdd(source.id),
                        placeholder: selfAdd(source.placeholder),
                        title: selfAdd(source.title),
                        value: selfAdd(source.value),
                    }));
                }
            },
            dec: function (min = 2) {
                let tree = this.parentElement.parentElement;
                if (tree.childElementCount == 3 && /^indep\d$/.test(tree.id)) tree.appendChild = e => e;
                if (tree.childElementCount > min) tree.lastElementChild.remove();
            },
            del: function () { this.parentElement.remove() },
            info: function () { },
        });
        Object.assign(HTMLDivElement.prototype, {
            init() {
                this.editor = this.addEditor(this.onCheck, this.onEdit);
                this.datas = this.datas || function () { return [this] };
                this.update && this.update();
                this.initFunc && this.initFunc();
                return this;
            },
            dataElm(id, exp, elm, tag = 'div') {
                let arr = exp.split(',').map(e => e.split('|'));
                let inputs = arr.map(e => `<input id="${id}_${e[0]}" type="${e[2] || 'number'}" placeholder="${e[1] || e[0]}" ${e[3] || ''}>`).join('\n');
                return `<${tag} id="${id}_data" >${elm || ''}${inputs}</${tag}>`;
            },
            readTextareaData() {
                let textarea = this.editor.$('textarea');
                let text = textarea.value.replace(/ +/g, '').replace(/\n$/, ''),
                    arr = text.split('\n').map(e => e.split('\t'));
                textarea.value = '';
                if (arr[1]) {
                    let list = this.datas().map(e => e.$('input[placeholder]', 1));
                    arr.forEach((e, r) => {
                        e.forEach((ee, c) => { if (list[r] && list[r][c]) list[r][c].value = ee; });
                    });
                }
            },
            writeData(dataElm, prop) {
                let id = dataElm.id.split('_')[0];
                window[id] = window[id] || {};
                let obj = window[id];
                function data(elm) { // 根据单个元素 返回数据对象
                    let obj = {};
                    elm.$('input[id]', 1).forEach(e => {
                        obj[e.id.match(/_([^_]+)$/)[1]] = e.type == 'number' ? +e.value : e.value;
                    });
                    return obj;
                }
                if (prop) { // 多个元素 写入数组
                    !function selet(arr) {
                        let p = arr.shift();
                        if (arr[0]) { obj = obj[p] = {}; selet(arr); }
                        else { obj = obj[p] = []; }
                    }(prop.split('.'));
                    Object.assign(obj, [...dataElm.children].map(data));
                } else { // 单个元素 写入对象
                    Object.assign(obj, data(dataElm));
                }
                return window[id];
            },
            onCheck() {
                this.readTextareaData();
                let errInput = [];
                let colors = function (isOK) {
                    isOK = isOK + 0;
                    if ($('html').style.filter) return ['#0ff7', '#f0f7'][isOK]; // dark 模式
                    else return ['#f005', '#0f05'][isOK];;
                };
                [... this.$('input[placeholder]', 1)].forEach(e => {
                    e.style.backgroundColor = colors(true);
                    if (['', NaN, undefined].includes(e.value)) errInput.push(e);
                });
                if (errInput[0]) errInput.forEach(e => e.style.backgroundColor = colors(false));
                else this.confirm(), console.log(this.output());
            },
            onEdit() {
                [... this.$('input[placeholder]', 1)].forEach(e => {
                    e.style.backgroundColor = '';
                });
            },
            output() { return this.id },
        });
        Object.assign(Node.prototype, {
            addTools: function (max, min) {
                return this.insertBefore(addElm('span', {
                    id: `${this.id}_tools`,
                    className: 'tools',
                    innerHTML: `<input class="add" type="button" value="+" onclick="this.add(${max})">
                                <input class="dec" type="button" value="-" onclick="this.dec(${min})">`,
                }), this.children[0]);
            },
            addEditor: function (func1 = () => { }, func2 = () => { }) {
                let _this = this;
                let elm = this.appendChild(addElm('span', {
                    id: `${this.id}_editor`,
                    className: 'editor',
                    innerHTML: `<input type="button" value="确认" onclick="this.handle()">
                               <!-- <input type="button" value="i" class="info" onclick="this.info()"> -->
                                <textarea cols="2" rows="1"></textarea>`,
                }));
                elm.$('input').handle = function () {
                    [..._this.$('input', true)].filter(e => e.id || e.className).forEach(e => e.disabled = !e.disabled);
                    elm.$('textarea').or('disabled', true, false);
                    elm.$('textarea').style.or('resize', '', 'none');
                    this.or('value', '确认', '编辑') ? func1.call(_this) : func2.call(_this);
                };
                return elm;
            },
            insertBefore: function (node, pos) {
                let o = node.id && $(`#${node.id}`);
                if (!o) return _insertBefore.call(this, node, pos);
                else console.log(`已存在`, o);
                return o;
            },
            appendChild: function (node) {
                let o = node.id && $(`#${node.id}`);
                if (!o) return _appendChild.call(this, node);
                else console.log(`已存在`, o);
                return o;
            },
        });
        window.onerror = function (...e) { $('#debugInfo').appendChild(addElm('li', { innerHTML: `${e[2]}&nbsp;&nbsp;&nbsp;${e[0]}` })); }
        addBox('base');

        function addElm(tag, ...config) { return Object.assign(document.createElement(tag), ...config); }
        function datalist(id, arr, func = e => e) {
            return `<datalist id="${id}">
                ${arr.map((e, i) => `<option value="${func(e)}" index="${i}"></option>`).join('')}
                </datalist>`;
        }
        function Mode(...funcs) { return funcs[$('#mode').selectedIndex](); }
        function addBox(name, id) {
            const op = {
                MSD(...level) {
                    let MSDtable = window['MSDtable'];
                    if (MSDtable instanceof Element) return alert('请先填写MSDtable'), {};
                    let In = e => e != -1 ? true : false;
                    let w = MSDtable.rows.indexOf(level[0]),
                        h = MSDtable.columns.indexOf(level[0]);
                    if (In(w) == In(h)) {
                        debugger;
                    } else if (In(w)) {
                        h = MSDtable.columns.indexOf(level[1] || 'mean');
                        if (!In(h)) debugger;
                    } else {
                        w = MSDtable.rows.indexOf(level[1] || 'mean');
                        if (!In(w)) debugger;
                    }
                    let { M, SD } = MSDtable.data[w][h];
                    return {
                        M: M, SD: SD,
                        text: `(M = ${M.toFixed(2)}, SD = ${SD.toFixed(2)})`
                    }
                },
                ifRes(type, arg1, arg2) {
                    switch (type) {
                        case 'p**': return arg1 == 0 ? 'p < 0.001' : 'p = ' + arg1.toFixed(3);
                        case 'p*': return arg1 < 0.05 ? '显著' : '不显著';
                        case 'M': return arg1.M > arg2.M ? '大于' : '小于';
                        case 'ia': {
                            let names = arg1.split('×');
                            return names[1] ? `${arg1}交互作用` : arg1 + '主效应';
                        }
                        default: break;
                    }
                },
                sign(p, l1, l2, msd1, msd2) {
                    return p < 0.05 ?
                        `${l1}的$dep${msd1.text}显著${op.ifRes('M', msd1, msd2)}${l2}${msd2.text}` :
                        `${l1}的$dep${msd1.text}与${l2}${msd2.text}无显著差异`;
                }
            };
            let boxInfo = {
                base() {
                    return {
                        id: 'base',
                        innerHTML: `<div id="dep"><input id="d1" type="text" placeholder="因变量1"></div>
                            <div id="indep"><div id="i1">
                                <input class="name" type="text" placeholder="自变量">
                                <input class="level" type="text" placeholder="水平1">
                                <input class="level" type="text" placeholder="水平2">
                            </div></div>`,
                        datas() { return [...$('#indep').$('div', 1)] },
                        confirm() {
                            // 更新变量
                            window['vs'] = [];
                            (function (...vs) {
                                let e; vs.forEach(v => {
                                    window[`${v.type}s`] = [];
                                    for (let i = 1; i <= v.elm.childElementCount - 1; i++) {
                                        Object.assign(e = $(`#${v.type}${i}`), v.get(e));
                                        window[e.id] = e;
                                        if (!window['vs'].includes(window[e.id])) {
                                            window[`${v.type}s`].push(window[e.id]);
                                            window['vs'].push(window[e.id]);
                                        }
                                    }
                                });
                            })({
                                type: 'd', elm: $('#dep'), get({ value }) { return { name: value } },
                            }, {
                                type: 'i', elm: $('#indep'), get(e) {
                                    return {
                                        name: e.$('input.name').value,
                                        ls: [...e.$('input.level', 1)].map(e => e.value),
                                    }
                                },
                            });
                            // 更新 datalist
                            $('#datalists').innerHTML = '';
                            is.forEach(e => $('#datalists').innerHTML += datalist(`${e.id}_ls`, e.ls));
                            // 更新dom
                            $('#base ~ div[id]', 1).forEach(e => { e.remove(); });
                            Mode(e => {
                                addBox('MSDtable');
                                if (is.length + i1.ls.length == 3) addBox('Ttest');
                                else addBox('Ftest');
                            }, e => {
                                addBox('LinearModel');
                                addBox('Linear');
                            }, e => { addBox('Mediation') });

                        },
                        output() {
                            return Mode(e => {
                                let method = '';
                                if (is.length == 1 && i1.ls.length == 2 && ds.length == 1) method = `t检验`;
                                else {
                                    method = `${'0单双'[is.length] || '多'}因素`;
                                    if (ds.length > 1) method += '多元';
                                    method += '方差分析';
                                }
                                let indepInfo = is.map(({ name, ls }) => `${ls.length}(${name}: ${ls.join(' / ')})`);
                                return `对${ds.map(e => e.name).join('、')}采用${is.length > 1 ? indepInfo.join('×') : ''}${method}`
                            }, e => {
                                return `以${ds[0].name}为因变量，${is.map(e => e.name).join('、')}为自变量，进行标准${is.length > 1 ? '多元' : ''}线性回归`
                            }, e => {
                                return '';
                            });
                        },
                        initFunc() {
                            $('#dep').addTools(2);
                            Mode(e => {
                                $('#indep').addTools(3);
                                $('#i1').addTools(6, 4);
                            }, e => {
                                $('#indep').addTools(10);
                                $('#i1').addTools();
                            }, e => {
                                $('#indep').addTools(5);
                                $('#i1').addTools();
                            });
                        }
                    }
                },
                // 差异检验
                MSDtable() {
                    return {
                        id: `MSDtable`,
                        innerHTML: `<table id="MSDtable_body"></table>`,
                        datas: function () { return [...$('#MSDtable_body').$('tbody').children] },
                        confirm: function () {
                            let dataArr = this.datas().map(e => {
                                let row = [...e.$('.MSD', true)].map(ee => {
                                    return {
                                        M: parseFloat(ee.children[0].value),
                                        SD: parseFloat(ee.children[1].value)
                                    }
                                });
                                return [...row, { M: row.mean('M'), SD: row.mean('SD') }]
                            });
                            let i2 = window['i2'] || { ls: [] };
                            window['MSDtable'] = {
                                rows: [...i2.ls, 'mean'],
                                columns: [...i1.ls, 'mean'],
                                data: [...dataArr, dataArr[0].map((e, i) => {
                                    return {
                                        M: dataArr.map(ee => ee[i]).mean('M'),
                                        SD: dataArr.map(ee => ee[i]).mean('SD')
                                    }
                                })]
                            };
                        },
                        update: function () {
                            let trh, trb;
                            if (window['i2']) {
                                trh = `<tr>${[
                                    `<th>${i2.name}\\${i1.name}</th>`,
                                    ...i1.ls.map((e, i) => `<th id="i1l${i + 1}">${e}</th>`)
                                ].join('')}</tr>`;
                                trb = i2.ls.map((e, i) => `<tr><th id="i2l${i + 1}">${e}</th>\
                    ${i1.ls.map((ee, j) => this.dataElm(`i2l${i + 1}&i1l${j + 1}_MSD`, 'M,SD', '', 'th')).join('')}\
                    </tr>`).join('');
                            } else {
                                trh = `<tr>${[
                                    `<th>\\${i1.name}</th>`,
                                    ...i1.ls.map((e, i) => `<th id="i1l${i + 1}">${e}</th>`)
                                ].join('')}</tr>`;
                                trb = `<tr><th></th>\
                    ${i1.ls.map((ee, j) => this.dataElm(`i1l${j + 1}_MSD`, 'M,SD', '', 'th')).join('')}\
                    </tr>`;
                            };
                            $('#MSDtable_body').innerHTML = `<thead>${trh}</thead><tbody>${trb}</tbody>`;
                        },
                    }
                },
                Ttest() {
                    return {
                        id: 'Ttest',
                        innerHTML: `<div id="Ttest_body"></div>`,
                        confirm() {
                            this.writeData(this.$('#i1_Tdata'));
                        },
                        update() {
                            $('#Ttest_body').innerHTML = this.dataElm('i1_Ttest', 't,df,p,CohenD|Cohen d,ciL|CI下限,ciU|CI上限', `<label>${window['i1'].name}</label>`);
                        },
                        output() {
                            return (function ({ ls, t, df, p, CohenD, ciL, ciU }) {
                                let [l1, l2] = ls;
                                let msd1 = op.MSD(l1), msd2 = op.MSD(l2);
                                return `${op.sign(p, l1, l2, msd1, msd2)}, t(${df}) = ${t.toFixed(2)}, ${op.ifRes('p**', p)}, Cohen d = ${CohenD.toFixed(2)}, 90%CI[${`${ciL.toFixed(2)}, ${ciU.toFixed(2)}`}]`
                            })(i1);
                        }
                    }
                },
                Ftest() {
                    return {
                        id: 'Ftest',
                        innerHTML: `<div id="Ftest_body"></div>`,
                        datas() { return [...$('#Ftest_body').children] },
                        confirm() {
                            $('.post,.simple', 1).forEach(e => e.remove());
                            this.is = [];
                            this.datas().map(e => {
                                let i = this.writeData(e);
                                this.is.push(i);
                                if (i.p < 0.05) {
                                    if (i.id.includes('×')) addBox('simple', i.id);
                                    else if (i.ls.length > 2) addBox('post', i.id);
                                }
                            });
                        },
                        update() {
                            let data = [];
                            is.forEach((e, i) => {
                                data.push(...is.choose(i + 1).map(es => {
                                    let id = es.map(e => e.id).join('×');
                                    if (i > 0) window[id] = { id: id, name: es.map(e => e.name).join('×'), is: es, };
                                    return this.dataElm(`${id}_Ftest`, 'F,df1,df2,p,eta2|η2,ciL|CI下限,ciU|CI上限', `<label>${window[id].name}</label>`);
                                }));
                            });
                            $('#Ftest_body').innerHTML = data.join('');
                        },
                        output() {
                            return this.is.map(function ({ name, F, df1, df2, p, eta2, ciL, ciU }) {
                                return `${op.ifRes('ia', name)}${op.ifRes('p*', p)}, F(${df1}, ${df2}) = ${F.toFixed(2)}, ${op.ifRes('p**', p)}, η2 = ${eta2.toFixed(2)}, 90%CI[${`${ciL.toFixed(2)}, ${ciU.toFixed(2)}`}]`
                            }).join('；');
                        }
                    }
                },
                post() {
                    return {
                        i: window[id],
                        id: `${id}_post`,
                        className: 'post box',
                        title: `${id} 事后检验`,
                        innerHTML: `<label for="${id}">${window[id].name}</label>
                            <div id="${id}_post_body"></div>`,
                        confirm() {
                            this.writeData($(`#${id}_post_body`), 'post');
                        },
                        update() {
                            $(`#${id}_post_body`).innerHTML = this.i.ls.choose(2).map((e, i) =>
                                this.dataElm(`${id}_post${i}`, `l1|水平1|text|value="${e[0]}",l2|水平2|text|value="${e[1]}",p`,
                                    '<input class="del" type="button" value="×" onclick="this.del()" >')).join('')
                        },
                        output() {
                            return `对${this.i.name}进行事后检验发现，${this.i.post.map(function ({ l1, l2, p }) {
                                let msd1 = op.MSD(l1), msd2 = op.MSD(l2);
                                return `${op.sign(p, l1, l2, msd1, msd2)}, ${op.ifRes('p**', p)}`
                            }).join('；')}。`;
                        },
                        initFunc() { this.$('textarea').style.display = 'none'; },
                    }
                },
                simple() {
                    return {
                        i: window[id],
                        id: `${id}_simple`,
                        className: 'simple box',
                        title: `${id} 简单效应分析`,
                        innerHTML: `<label for="${id}">${window[id].name}</label>
                            <div id="${id}_simple_body"></div>`,
                        confirm() {
                            this.writeData($(`#${id}_simple_body`), 'simple');
                        },
                        update() {
                            let args = [];
                            window[id].is.forEach((e, i, arr) => {
                                arr[i].ls.forEach(l => {
                                    arr[+!i].ls.choose(2).forEach(ll => {
                                        args.push({ fixed_i: e.name, fixed_il: l, l1: ll[0], l2: ll[1] })
                                    });
                                });
                            });
                            $(`#${id}_simple_body`).innerHTML = args.map((e, i) =>
                                this.dataElm(`${id}_simple${i + 1}`,
                                    `fixed_i|自变量|text|value="${e.fixed_i}",fixed_il|固定水平|text|value="${e.fixed_il}",l1|水平1|text|value="${e.l1}",l2|水平2|text|value="${e.l2}",p`,
                                    '<input class="del" type="button" value="×" onclick="this.del()">')).join('');
                        },
                        output() {
                            return `${this.i.name}的简单效应分析发现，${this.i.simple.map(function ({ l1, l2, p, fixed_i, fixed_il }) {
                                let msd1 = op.MSD(fixed_il, l1), msd2 = op.MSD(fixed_il, l2);
                                return `${fixed_i}为${fixed_il}时，${op.sign(p, l1, l2, msd1, msd2)}, ${op.ifRes('p**', p)}`
                            }).join('；')}。`
                        },
                        initFunc() { this.$('textarea').style.display = 'none'; },
                    }
                },
                // 线性回}归                '
                LinearModel() {
                    return {
                        id: 'model',
                        innerHTML: `<label for="model">回归模型</label>
                    <input id="model_R2" type="number" step="0.01" placeholder="R方">
                    <input id="model_F" type="number" placeholder="F值">
                    <input id="model_df1" type="number" placeholder="自由度1">
                    <input id="model_df2" type="number" placeholder="自由度2">
                    <input id="model_p" type="number" step="0.01" placeholder="p值">`,
                        confirm() {
                            this.writeData(this);
                        },
                        output() {
                            return (function ({ R2, F, df1, df2, p }) {
                                return `整体模型调整后的解释方差为${(R2 * 1e2).toFixed(1)}%, F(${df1}, ${df2}) = ${F.toFixed(2)}, ${op.ifRes('p**', p)}`
                            })(window['model']);
                        },
                        initFunc() { this.$('textarea').style.display = 'none'; },
                    }
                },
                Linear() {
                    return {
                        id: 'Linear',
                        innerHTML: `<div id="Linear_body"></div>`,
                        datas() { return [...$('#Linear_body').children] },
                        confirm() {
                            this.is = this.datas().map(this.writeData);
                        },
                        update() {
                            $('#Linear_body').innerHTML = is.map(({ id }) => this.dataElm(`${id}_Linear`, 'beta|标准β,t,df,p', `<label for="${id}">${window[id].name}</label>`)).join('');
                        },
                        output() {
                            return this.is.map(function ({ name, beta, t, df, p, ls }) {
                                let orient = '';
                                if (p < 0.05) {
                                    orient = '高低';
                                    if (ls.length == 2) orient = `，${ls[0]}的$dep${orient[+(beta > 0)]}于${ls[1]}`;
                                    else orient = `，${name}越${orient[0]}，$dep越${orient[+!(beta > 0)]}`;
                                }
                                return `${name}的预测作用${op.ifRes('p*', p)}, β = ${beta.toFixed(2)}, t(${df}) = ${t}, ${op.ifRes('p**', p)}${orient}`
                            }).join('；');
                        },
                    }
                },
                // 中介模型
                Mediation() {
                    return {
                        id: 'Media',
                        innerHTML: '<div id="Media_body"></div>',
                        datas() { return [...$('#Media_body').children] },
                        confirm() { },
                        update() {
                            let paths = [];
                            is.slice(1).forEach((e, i, arr) =>
                                paths.push(arr.choose(i + 1).map(es => {
                                    let names = [i1.name, ...es.map(e => e.name), d1.name].join('→');
                                    return this.dataElm(`${names}`, 'effect|间接效应,ciL|CI下限,ciU|CI上限', `<label>${names}</label>`)
                                }).join(''))
                            );
                            $('#Media_body').innerHTML = paths.join('');
                        },
                        output() { return ``;},
                        initFunc() {
                            let list = this.$('label', 1);
                            list.forEach(e => {
                                e.style.transition = 'none';
                                e.style.width = getComputedStyle(list[list.length - 1]).width;
                            });
                        },
                    }
                },
                // 调节模型
                Moderation() { },
                // 输出模块
                output() {
                    return {
                        id: 'output',
                        className: 'box',
                        innerHTML: `<div id="output_content" contenteditable></div>`,
                        confirm() { // 复制文本
                            $('#output_content').contentEditable = false;
                            let { innerText, innerHTML } = $('#output_content');
                            navigator.clipboard.write([
                                new ClipboardItem({
                                    'text/plain': new Blob([innerText], { type: 'text/plain' }),
                                    'text/html': new Blob([innerHTML], { type: 'text/html' }),
                                })
                            ]).then(e => alert('复制成功\n可以带格式粘贴'));
                        },
                        onEdit() {
                            $('#output_content').contentEditable = true;
                            $('#output_content').focus();
                        },
                        update() {
                            function txt(text, tag, style = "") {
                                if (tag == 'p') style += `font-family: 'Times New Roman','宋体';font-size: 10.5pt;font-weight: normal;text-indent: 2em;margin: 0;line-height: 1.5;`;
                                return `<${tag} style="${style}">${text}</${tag}>`
                            }
                            // 主要内容
                            let text = Mode(e => {
                                return txt(`${$('#base').output()}。结果发现，${($('#Ttest') || $('#Ftest')).output()}。`, 'p')
                                    + [...$('.post', 1)].map(e => txt(e.output(), 'p')).join('')
                                    + [...$('.simple', 1)].map(e => txt(e.output(), 'p')).join('');
                            }, e => {
                                return txt(`${$('#base').output()}。各变量的相关矩阵见表1。回归分析结果显示，${$('#LinearModel').output()}。`, 'p')
                                    + txt(`当其他自变量不变时，${$('#Linear').output()}。`, 'p');
                            }, e => { return txt(``); })
                            // 格式化
                            $('#output_content').innerHTML = text.replace(/[χη](2)/g, `η${txt('$1', 'sup')}`)
                                .replace(/\s(F|p|t|d|M|SD|r|N|n)/g, ` ${txt('$1', 'i')}`)
                                .replace(/%(CI)\[/g, `%${txt('$1', 'i')}[`)
                                .replace(/\((M) /g, `(${txt('$1', 'i')} `)
                                .replace(/(t|F)检验/g, `${txt('$1', 'i')}检验`)
                                .replace(/ -(\d)/g, ` —$1`)
                                .replace(/\$dep/g, d1.name);
                        },
                        initFunc() {
                            $('#output_content').focus();
                            this.$('textarea').style.display = 'none';
                            if ($('html').style.filter) $('#output_content').style.filter = 'invert(1)';
                        },
                    }
                }
            }
            return $('body').appendChild(addElm('div', { className: 'box' }, boxInfo[name]())).init();
        }

    </script>
</body>

</html>